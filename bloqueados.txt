# GUERRILLA_DOMINIOS_BONS = [
#     "sharklasers.com",
#     "grr.la",
#     "guerrillamail.com",
#     "guerrillamail.net",
#     "guerrillamail.org",
#     "guerrillamail.info",
#     "guerrillamail.biz",
#     "guerrillamail.de",
#     # deixe guerrillamailblock.com por último, se quiser manter como fallback
#     "guerrillamailblock.com",
# ]

# def testar_guerrilla_funcional(session, tentativas=2, timeout=5):
#     """
#     Testa se a API do Guerrilla responde corretamente.
#     Não precisa receber email real, só validar resposta.
#     """
#     for _ in range(tentativas):
#         try:
#             r = session.get(
#                 "https://api.guerrillamail.com/ajax.php?f=check_email&seq=0",
#                 timeout=timeout
#             )
#             if r.status_code == 200 and isinstance(r.json(), dict):
#                 return True
#         except:
#             time.sleep(1)
#     return False


# class ProviderGuerrilla:
#     def gerar(self, banidos=[]):
#         obj = EmailSession()
#         obj.provider_name = "GuerrillaMail"
#         obj.session_requests = requests.Session()

#         tag = CONF.get("tag_email", "rag")

#         s = obj.session_requests

#         if not testar_guerrilla_funcional(s):
#             return None

#         # escolhe domínio “bom” (não banido) — se sobrar só block, ele entra como fallback
#         banidos = set([b.lower() for b in banidos])
#         dominios = [d for d in GUERRILLA_DOMINIOS_BONS if d.lower() not in banidos]
#         if not dominios:
#             return None

#         for i in range(6):
#             try:
#                 # pega sid_token (quando existir)
#                 r0 = s.get("https://api.guerrillamail.com/ajax.php?f=get_email_address", timeout=10)
#                 j0 = r0.json() if r0.status_code == 200 else {}
#                 obj.sid_token = j0.get("sid_token") or obj.sid_token

#                 sulfixo = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
#                 user_novo = f"{tag}_{sulfixo}"
#                 dominio = random.choice(dominios)

#                 # FORÇA domínio aqui
#                 url = (
#                     "https://api.guerrillamail.com/ajax.php"
#                     f"?f=set_email_user&email_user={user_novo}&domain={dominio}&lang=en"
#                 )
#                 # se sid_token existir, inclui (ajuda muito na consistência)
#                 if obj.sid_token:
#                     url += f"&sid_token={obj.sid_token}"

#                 r_set = s.get(url, timeout=10)
#                 j = r_set.json() if r_set.status_code == 200 else {}

#                 email_final = j.get("email_addr") or ""
#                 if not email_final:
#                     continue

#                 dom = email_final.split("@", 1)[1].lower()

#                 log_debug(f"Guerrilla gerou: {email_final} | sid_token={'OK' if obj.sid_token else 'NONE'}")


#                 if dom in banidos:
#                     continue

#                 obj.email = email_final
#                 return obj

#             except:
#                 time.sleep(1)

#         return None

#     def esperar_codigo(self, obj, filtro):
#         try:
#             url = "https://api.guerrillamail.com/ajax.php?f=check_email&seq=0"
#             if obj.sid_token:
#                 url += f"&sid_token={obj.sid_token}"

#             r = obj.session_requests.get(url, timeout=10)
#             if r.status_code == 200:
#                 for msg in r.json().get('list', []):
#                     if filtro.lower() in msg.get('mail_subject', '').lower():
#                         mail_id = msg.get('mail_id')
#                         if not mail_id:
#                             continue
#                         url2 = f"https://api.guerrillamail.com/ajax.php?f=fetch_email&email_id={mail_id}"
#                         if obj.sid_token:
#                             url2 += f"&sid_token={obj.sid_token}"
#                         r2 = obj.session_requests.get(url2, timeout=10)
#                         j2 = r2.json() if r2.status_code == 200 else {}
#                         return j2.get('mail_body', '')
#         except:
#             pass
#         return None

# class ProviderMailTM:
#     def gerar(self, banidos=[]):
#         obj = EmailSession(); obj.provider_name = "Mail.tm"; tag = CONF.get("tag_email", "rag")
#         try:
#             r = requests.get("https://api.mail.tm/domains", timeout=5)
#             doms = r.json()['hydra:member']
#             disponiveis = [d['domain'] for d in doms if d['domain'] not in banidos]
#             if not disponiveis:
#                 log_debug("MailTM: Todos os domínios estão banidos nesta sessão.")
#                 return None
#             coms = [d for d in disponiveis if d.endswith(".com")]
#             domain = random.choice(coms) if coms else random.choice(disponiveis)
#             sulfixo = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
#             obj.email = f"{tag}_{sulfixo}@{domain}"
#             requests.post("https://api.mail.tm/accounts", json={"address": obj.email, "password": obj.senha_api}, timeout=5)
#             r_tok = requests.post("https://api.mail.tm/token", json={"address": obj.email, "password": obj.senha_api}, timeout=5)
#             if r_tok.status_code == 200: obj.token = r_tok.json()['token']; return obj
#         except: pass
#         return None

#     def esperar_codigo(self, obj, filtro):
#         headers = {"Authorization": f"Bearer {obj.token}"}
#         try:
#             r = requests.get("https://api.mail.tm/messages", headers=headers, timeout=5)
#             if r.status_code == 200:
#                 for msg in r.json()['hydra:member']:
#                     if filtro.lower() in msg['subject'].lower() and not msg['seen']:
#                         det = requests.get(f"https://api.mail.tm/messages/{msg['id']}", headers=headers)
#                         requests.patch(f"https://api.mail.tm/messages/{msg['id']}", headers=headers, json={"seen": True})
#                         return det.json()['text']
#         except: pass
#         return None

# class Provider1SecMail:
#     def gerar(self, banidos=[]):
#         obj = EmailSession(); obj.provider_name = "1secmail"; tag = CONF.get("tag_email", "rag")
#         try:
#             r = requests.get("https://www.1secmail.com/api/v1/?action=getDomainList", timeout=5)
#             if r.status_code == 200:
#                 doms = r.json()
#                 bons = [d for d in doms if d not in banidos]
#                 if not bons: 
#                     log_debug("1SecMail: Todos domínios banidos.")
#                     return None
#                 obj.domain_1sec = random.choice(bons)
#             else: 
#                 if "esiix.com" not in banidos: obj.domain_1sec = "esiix.com"
#                 else: return None
#             sulfixo = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
#             obj.login_1sec = f"{tag}_{sulfixo}"
#             obj.email = f"{obj.login_1sec}@{obj.domain_1sec}"
#             return obj
#         except: return None

#     def esperar_codigo(self, obj, filtro):
#         try:
#             url = f"https://www.1secmail.com/api/v1/?action=getMessages&login={obj.login_1sec}&domain={obj.domain_1sec}"
#             r = requests.get(url, timeout=5)
#             if r.status_code == 200:
#                 for msg in r.json():
#                     if filtro.lower() in msg['subject'].lower():
#                         r2 = requests.get(f"https://www.1secmail.com/api/v1/?action=readMessage&login={obj.login_1sec}&domain={obj.domain_1sec}&id={msg['id']}", timeout=5)
#                         return r2.json().get('textBody') or r2.json().get('body')
#         except: pass
#         return None